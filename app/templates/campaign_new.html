{% extends "base.html" %}

{% block title %}New Campaign{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Bulk Email</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/contacts">Contacts</a></li>
                <li class="nav-item"><a class="nav-link" href="/templates">Templates</a></li>
                <li class="nav-item"><a class="nav-link" href="/groups">Groups</a></li>
                <li class="nav-item"><a class="nav-link" href="/settings">Settings</a></li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2>Create New Campaign</h2>

    <ul class="nav nav-tabs" id="campaign-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="broadcast-tab" data-bs-toggle="tab" data-bs-target="#broadcast-pane" type="button" role="tab">Broadcast Mode</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cluster-tab" data-bs-toggle="tab" data-bs-target="#cluster-pane" type="button" role="tab">Cluster Mode</button>
        </li>
    </ul>

    <div class="tab-content" id="campaign-tabs-content">
        <!-- Broadcast Tab -->
        <div class="tab-pane fade show active" id="broadcast-pane" role="tabpanel">
            <div class="card card-body mt-3">
                <form id="broadcast-form">
                    <div class="mb-3">
                        <label for="broadcast-campaign-name" class="form-label">Campaign Name</label>
                        <input type="text" class="form-control" id="broadcast-campaign-name" required placeholder="e.g., 'Monthly Newsletter - August'">
                    </div>
                    <div class="mb-3">
                        <label for="broadcast-template-select" class="form-label">Select a Template</label>
                        <select class="form-select" id="broadcast-template-select" required></select>
                    </div>
                    <button type="submit" class="btn btn-danger">Send Broadcast to All Contacts</button>
                </form>
            </div>
        </div>

        <!-- Cluster Tab -->
        <div class="tab-pane fade" id="cluster-pane" role="tabpanel">
            <div class="card card-body mt-3">
                <form id="cluster-form">
                    <div class="mb-3"><label for="cluster-campaign-name" class="form-label">Campaign Name</label><input type="text" class="form-control" id="cluster-campaign-name" required></div><hr>
                    <div id="cluster-targets"></div>
                    <button type="button" class="btn btn-success mt-2" id="add-target-btn">Add Target</button><hr>
                    <button type="submit" class="btn btn-danger">Send Cluster Campaign</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let allTemplates = [];
let allGroups = [];

document.addEventListener("DOMContentLoaded", async function() {
    await loadInitialData();
    setupBroadcastForm();
    setupClusterForm();
});

async function loadInitialData() {
    const [templatesRes, groupsRes] = await Promise.all([fetch("/templates/"), fetch("/groups/")]);
    allTemplates = await templatesRes.json();
    allGroups = await groupsRes.json();
    populateTemplateSelect(document.getElementById('broadcast-template-select'), allTemplates);
}

function setupBroadcastForm() {
    document.getElementById("broadcast-form").addEventListener("submit", async function(event) {
        event.preventDefault();
        if (!confirm("Send broadcast to ALL contacts?")) return;
        const campaignName = document.getElementById("broadcast-campaign-name").value;
        const templateId = document.getElementById("broadcast-template-select").value;
        const response = await fetch("/campaigns/broadcast", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ name: campaignName, template_id: parseInt(templateId) })
        });
        if (response.ok) {
            alert("Broadcast sent!");
            window.location.href = '/dashboard';
        } else {
            alert("Failed to send broadcast.");
        }
    });
}

function setupClusterForm() {
    const addTargetBtn = document.getElementById("add-target-btn");
    const targetsContainer = document.getElementById("cluster-targets");
    addTargetBtn.addEventListener("click", addClusterTargetRow);

    document.getElementById("cluster-form").addEventListener("submit", async function(event) {
        event.preventDefault();
        const campaignName = document.getElementById("cluster-campaign-name").value;
        const targets = [];
        document.querySelectorAll("#cluster-targets .row").forEach(row => {
            const groupId = row.querySelector('.group-select').value;
            const templateId = row.querySelector('.template-select').value;
            if (groupId && templateId) {
                targets.push({ group_id: parseInt(groupId), template_id: parseInt(templateId) });
            }
        });
        if (targets.length === 0) return alert("Please add at least one target.");
        if (!confirm("Send cluster campaign?")) return;
        const response = await fetch("/campaigns/cluster", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ name: campaignName, targets: targets })
        });
        if (response.ok) {
            alert("Cluster campaign sent!");
            window.location.href = "/dashboard";
        } else {
            alert("Failed to send cluster campaign.");
        }
    });
}

function addClusterTargetRow() {
    const targetId = Date.now();
    const newTargetRow = document.createElement('div');
    newTargetRow.className = 'row mb-2 align-items-center';
    newTargetRow.id = `target-${targetId}`;
    newTargetRow.innerHTML = `
        <div class="col-md-5"><select class="form-select group-select"></select></div>
        <div class="col-md-5"><select class="form-select template-select"></select></div>
        <div class="col-md-2"><button type="button" class="btn btn-sm btn-outline-danger" onclick="document.getElementById('target-${targetId}').remove()">Remove</button></div>
    `;
    document.getElementById("cluster-targets").appendChild(newTargetRow);
    populateGroupSelect(newTargetRow.querySelector('.group-select'), allGroups);
    populateTemplateSelect(newTargetRow.querySelector('.template-select'), allTemplates);
}

function populateTemplateSelect(select, templates) {
    select.innerHTML = '<option value="">-- Select Template --</option>';
    templates.forEach(t => { select.innerHTML += `<option value="${t.id}">${t.name}</option>`; });
}

function populateGroupSelect(select, groups) {
    select.innerHTML = '<option value="">-- Select Group --</option>';
    groups.forEach(g => { select.innerHTML += `<option value="${g.id}">${g.name}</option>`; });
}
</script>
{% endblock %}
